<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Category Performance Dashboard</title>
    <!-- Bootstrap CSS CDN for professional appearance -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        /* Custom styles for a cleaner look */
        body {
            background-color: #f8f9fa; /* Light grey background */
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .container {
            margin-top: 50px;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* Subtle shadow for depth */
        }
        h1, h2 {
            color: #343a40; /* Darker text for headings */
            margin-bottom: 25px;
            font-weight: 600;
        }
        .lead {
            color: #6c757d; /* Muted text for description */
            margin-bottom: 30px;
        }
        .table-responsive {
            margin-top: 30px;
        }
        .table-striped > tbody > tr:nth-of-type(odd) > * {
            background-color: #f2f2f2; /* Lighter stripe color */
        }
        .table-hover tbody tr:hover {
            background-color: #e9ecef; /* Hover effect */
            cursor: default;
        }
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 120px; /* Ensures spinner is centered and visible */
            flex-direction: column;
            color: #0d6efd; /* Bootstrap primary color */
        }
        .loading-spinner .spinner-border {
            width: 3rem;
            height: 3rem;
            margin-bottom: 10px;
        }
        .error-message {
            color: #dc3545; /* Bootstrap danger color */
            font-weight: bold;
            padding: 20px;
            border: 1px solid #dc3545;
            border-radius: 5px;
            background-color: #f8d7da;
        }
        .error-message a {
            color: #0d6efd;
            text-decoration: none;
        }
        .error-message a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">Product Category Performance Dashboard</h1>
        <p class="lead text-center">
            This single-page application displays aggregated financial performance data by product category.
            The data is generated dynamically by a Python script, processed via a GitHub Actions CI/CD pipeline,
            and published as a JSON file to GitHub Pages for the frontend to consume.
        </p>

        <!-- Loading Indicator -->
        <div id="loading" class="loading-spinner">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading performance data...</p>
        </div>

        <!-- Error Message Display -->
        <div id="error" class="error-message text-center" style="display: none;">
            <p><strong>Error:</strong> Failed to load data.</p>
            <p>Please ensure the backend workflow has run successfully and the
                <a href="./result.json" target="_blank" rel="noopener noreferrer">result.json</a>
                file is accessible on GitHub Pages. You might need to refresh the page or check your browser's console for details.
            </p>
        </div>

        <!-- Data Table Display -->
        <div id="data-table" class="table-responsive" style="display: none;">
            <h2 class="text-center">Aggregated Product Performance</h2>
            <table class="table table-striped table-hover caption-top">
                <caption>Summary of key financial metrics per product category.</caption>
                <thead class="table-dark">
                    <tr>
                        <th>Product Category</th>
                        <th>Total Revenue</th>
                        <th>Total Cost</th>
                        <th>Total Profit</th>
                        <th>Average Profit Margin</th>
                    </tr>
                </thead>
                <tbody id="data-rows">
                    <!-- Data will be dynamically inserted here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Bootstrap JS CDN (bundle includes Popper for dropdowns, etc., though not strictly needed for this table-only page) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loadingIndicator = document.getElementById('loading');
            const errorContainer = document.getElementById('error');
            const dataTableContainer = document.getElementById('data-table');
            const dataRows = document.getElementById('data-rows');

            // The URL for result.json on GitHub Pages.
            // './result.json' works if GitHub Pages is configured to serve from the root
            // and result.json is at the root of the published site.
            // For example: https://<YOUR_USERNAME>.github.io/<YOUR_REPOSITORY_NAME>/result.json
            const RESULT_JSON_URL = './result.json';

            /**
             * Fetches data from the specified URL and populates the table.
             */
            fetch(RESULT_JSON_URL)
                .then(response => {
                    // Check if the HTTP response was successful (status 200-299)
                    if (!response.ok) {
                        // Throw an error to be caught by the .catch() block
                        throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                    }
                    return response.json(); // Parse the JSON data from the response
                })
                .then(data => {
                    // Data successfully fetched and parsed
                    loadingIndicator.style.display = 'none'; // Hide the loading spinner
                    dataTableContainer.style.display = 'block'; // Show the data table

                    if (!Array.isArray(data) || data.length === 0) {
                        // Handle cases where data is empty or not an array
                        dataRows.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No data available to display.</td></tr>';
                        return;
                    }

                    // Populate the table with fetched data
                    data.forEach(item => {
                        const row = dataRows.insertRow(); // Create a new table row
                        row.insertCell().textContent = item.Product_Category;
                        row.insertCell().textContent = formatCurrency(item.Total_Revenue);
                        row.insertCell().textContent = formatCurrency(item.Total_Cost);
                        row.insertCell().textContent = formatCurrency(item.Total_Profit);
                        // Profit margin is usually stored as a percentage (e.g., 40 for 40%),
                        // so divide by 100 for `Intl.NumberFormat` which expects a fraction (e.g., 0.40).
                        row.insertCell().textContent = formatPercentage(item.Average_Profit_Margin);
                    });
                })
                .catch(error => {
                    // Handle any errors during the fetch operation
                    console.error('Failed to fetch data:', error);
                    loadingIndicator.style.display = 'none'; // Hide loading spinner
                    errorContainer.style.display = 'block'; // Show the error message to the user
                });

            /**
             * Formats a number as a USD currency string.
             * @param {number} value The numeric value to format.
             * @returns {string} The formatted currency string (e.g., "$1,234.56").
             */
            function formatCurrency(value) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(value);
            }

            /**
             * Formats a number as a percentage string.
             * Assumes the input `value` is already a percentage (e.g., 40 for 40%).
             * @param {number} value The numeric value to format.
             * @returns {string} The formatted percentage string (e.g., "40.00%").
             */
            function formatPercentage(value) {
                return new Intl.NumberFormat('en-US', {
                    style: 'percent',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(value / 100); // Divide by 100 as input is e.g. 40 (for 40%) not 0.40
            }
        });
    </script>
</body>
</html>